parameters:
- name: aptPackages
  type: object
  default: []
- name: registerROCmPackages
  type: boolean
  default: false
- name: aptToDnfMap
  type: object
  default:
    cmake: cmake
    doxygen: doxygen
    # note: doxygen-doc is not available in dnf
    # note: g++ is installed by default with gcc-toolset-14
    libdrm-dev: libdrm-devel
    libelf-dev: elfutils-libelf-devel
    libnuma-dev: numactl-devel
    # note: llvm needs ninja-build version newer than what dnf provides
    pkg-config: pkgconf-pkg-config
    # note: python3 is the default python in AlmaLinux 8
    # and python3-pip is already installed when updating to python 3.11
    zlib1g-dev: zlib-devel

steps:
- ${{ if eq(parameters.registerROCmPackages, true) }}:
  - task: Bash@3
    displayName: 'Register AMDGPU & ROCm repos (dnf)'
    inputs:
      targetType: inline
      script: |
        sudo rpm --import https://repo.radeon.com/rocm/rocm.gpg.key
        echo '[amdgpu]' | sudo tee /etc/yum.repos.d/amdgpu.repo > /dev/null
        echo "name=amdgpu" | sudo tee --append /etc/yum.repos.d/amdgpu.repo
        echo "baseurl=https://repo.radeon.com/amdgpu/$(REPO_RADEON_VERSION)/rhel/8.10/" | sudo tee --append /etc/yum.repos.d/amdgpu.repo
        echo "enabled=1" | sudo tee --append /etc/yum.repos.d/amdgpu.repo
        echo "gpgcheck=1" | sudo tee --append /etc/yum.repos.d/amdgpu.repo
        echo "gpgkey=https://repo.radeon.com/rocm/rocm.gpg.key" | sudo tee --append /etc/yum.repos.d/amdgpu.repo
        echo '[rocm]' | sudo tee /etc/yum.repos.d/rocm.repo > /dev/null
        echo "name=ROCm$(REPO_RADEON_VERSION)" | sudo tee --append /etc/yum.repos.d/rocm.repo
        echo "baseurl=https://repo.radeon.com/rocm/yum/$(REPO_RADEON_VERSION)/" | sudo tee --append /etc/yum.repos.d/rocm.repo
        echo "enabled=1" | sudo tee --append /etc/yum.repos.d/rocm.repo
        echo "gpgcheck=1" | sudo tee --append /etc/yum.repos.d/rocm.repo
        echo "gpgkey=https://repo.radeon.com/rocm/rocm.gpg.key" | sudo tee --append /etc/yum.repos.d/rocm.repo
        sudo dnf clean all
        sudo dnf makecache
- task: Bash@3
  displayName: 'dnf powertools and repositories'
  inputs:
    targetType: inline
    script: |
      sudo dnf config-manager --set-enabled powertools
      sudo dnf -y install epel-release git jq vim-common
- task: Bash@3
  displayName: 'Install gcc-toolset-14'
  inputs:
    targetType: inline
    script: sudo dnf -y install gcc-toolset-14
- task: Bash@3
  displayName: 'Enable GCC 14'
  inputs:
    targetType: inline
    script: |
      source /opt/rh/gcc-toolset-14/enable
      gcc --version
      g++ --version
- task: Bash@3
  displayName: 'Set CC/CXX env vars'
  inputs:
    targetType: inline
    script: |
      echo "##vso[task.setvariable variable=CC]/opt/rh/gcc-toolset-14/root/usr/bin/gcc"
      echo "##vso[task.setvariable variable=CXX]/opt/rh/gcc-toolset-14/root/usr/bin/g++"
- task: Bash@3
  displayName: 'Update to python 3.11'
  inputs:
    targetType: inline
    script: |
      sudo dnf -y module disable python36
      sudo dnf -y install python3.11 python3.11-pip
      sudo alternatives --set python /usr/bin/python3.11
      sudo alternatives --set python3 /usr/bin/python3.11
      python3 --version
      python3 -m pip install --upgrade pip setuptools wheel
- ${{ each pkg in parameters.aptPackages }}:
  # note: llvm needs ninja-build version newer than what dnf provides
  - ${{ if eq(pkg, 'ninja-build') }}:
    - task: Bash@3
      displayName: 'Install ninja 1.11.1'
      inputs:
        targetType: inline
        script: |
          curl -LO https://github.com/ninja-build/ninja/releases/download/v1.11.1/ninja-linux.zip
          sudo dnf -y install unzip
          unzip ninja-linux.zip
          sudo mv ninja /usr/local/bin/ninja
          sudo chmod +x /usr/local/bin/ninja
          echo "##vso[task.prependpath]/usr/local/bin"
  - ${{ if ne(parameters.aptToDnfMap[pkg], '') }}:
    - task: Bash@3
      displayName: 'dnf install ${{ parameters.aptToDnfMap[pkg] }}'
      inputs:
        targetType: inline
        script: |
          sudo dnf -y install ${{ parameters.aptToDnfMap[pkg] }}
