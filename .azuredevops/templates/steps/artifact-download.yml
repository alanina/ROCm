parameters:
# assumption componentName and pipeline name the same
- name: componentName
  type: string
  default: ''
- name: pipelineId
  type: string
  default: ''
- name: branchName
  type: string
  default: '$(Build.SourceBranchName)' # for tagged builds
- name: fileFilter
  type: string
  default: ''
# set to true if doing full build of ROCm stack
# and dependencies are pulled from same pipeline
- name: aggregatePipeline
  type: boolean
  default: false

steps:
- task: DownloadPipelineArtifact@2
  displayName: Download ${{ parameters.componentName }}
  inputs:
    ${{ if parameters.aggregatePipeline }}:
      buildType: 'current'
      itemPattern: '**/${{ parameters.componentName }}*${{ parameters.fileFilter }}*'
      allowPartiallySucceededBuilds: true
      targetPath: '$(Pipeline.Workspace)/d'
    ${{ else }}:
      buildType: 'specific'
      project: ROCm-CI
      specificBuildWithTriggering: true
      allowPartiallySucceededBuilds: true
      definition: ${{ parameters.pipelineId }}
      itemPattern: '**/*${{ parameters.fileFilter }}*'
      targetPath: '$(Pipeline.Workspace)/d'
      branchName: refs/heads/${{ parameters.branchName }}
      ${{ if eq(parameters.componentName, 'aomp') }}:
        buildVersionToDownload: latest # aomp trigger lives in ROCm/ROCm, so cannot use ROCm/aomp branch names
      ${{ else }}:
        buildVersionToDownload: latestFromBranch
- task: ExtractFiles@1
  displayName: Extract ${{ parameters.componentName }}
  inputs:
    archiveFilePatterns: '$(Pipeline.Workspace)/d/**/*.tar.gz'
    destinationFolder: '$(Agent.BuildDirectory)/rocm'
    cleanDestinationFolder: false
    overwriteExistingFiles: true
- task: DeleteFiles@1
  displayName: Cleanup Compressed ${{ parameters.componentName }}
  inputs:
    SourceFolder: '$(Pipeline.Workspace)/d'
    Contents: '**/*.tar.gz'
    RemoveDotFiles: true
